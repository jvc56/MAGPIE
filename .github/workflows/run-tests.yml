name: run-unit-tests
on: [push]
jobs:
  run-unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up GCC
        uses: egor-tensin/setup-gcc@v1
        with:
          version: latest
          platform: x64

      - name: Get lexica cache
        id: cache-lexica
        uses: actions/cache@v3
        with:
          path: ~/downloaded-lexica
          key: ${{runner.os}}-downloaded-lexica

      - name: Download lexica files
        if: steps.cache-lexica.outputs.cache-hit != 'true'
        run:
          - mkdir ~/downloaded-lexica
          - wget https://github.com/domino14/liwords/raw/master/liwords-ui/public/wasm/NWL20.kwg
          - wget https://github.com/domino14/liwords/raw/master/liwords-ui/public/wasm/CSW21.kwg
          - wget https://github.com/domino14/liwords/raw/master/liwords-ui/public/wasm/CSW21.klv2
          - wget https://github.com/domino14/liwords/raw/master/liwords-ui/public/wasm/english.klv2
          - wget https://github.com/domino14/macondo/raw/master/data/strategy/default_english/winpct.csv
          - wget https://woogles-prod-assets.s3.amazonaws.com/CSW21.csv.gz
          - mv *.kwg ~/downloaded-lexica
          - mv *.klv2 ~/downloaded-lexica
          - mv *.csv ~/downloaded-lexica
          - mv *.csv.gz ~/downloaded-lexica

      - name: Move lexica files in place
        run:
          - mkdir core/data/lexica && mkdir -p core/data/strategy/default_english
          - mv ~/downloaded-lexica/*.kwg core/data/lexica
          - mv ~/downloaded-lexica/*.klv2 core/data/lexica
          - mv ~/downloaded-lexica/winpct.csv core/data/strategy/default_english
          - mv ~/downloaded-lexica/CSW21.csv.gz core/data/lexica
          - cd core/data/lexica && gunzip CSW21.csv.gz

      - name: Run unit tests
        run: cd core && ./run u
